<html>
  <head></head>
  <body>
    <div id="output"></div>
    <button id="callMe">Call Me</button>
    <button id="listen">Listen</button>
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="watson-speech.js"></script>
    <script>
    class App {
      isTriggerKeyword(data) {
        return data.includes('interesting') || data.includes('Interesting');
      }

      makeCall(phoneNumber) {
        console.log('makeCall');
        console.log(phoneNumber)
        fetch('/call', {
          method: 'POST',
          body: JSON.stringify({
            phoneNumber: "+1" + phoneNumber
          }),
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        });
      }

      startListening() {
        var that = this;
        fetch('/watson-token').then(function(response) {
          return response.text();
        }).then((token) => {
          var stream = WatsonSpeech.SpeechToText.recognizeMicrophone({
              token: token,
              keepMic: true
          });

          stream.setEncoding('utf8'); // get text instead of Buffers for on data events

          stream.on('data', function(data) {
            if (that.isTriggerKeyword(data)) {
              console.log('Making a call..');
              stream.stop();
              that.makeCall(localStorage.getItem("phoneNumber"));
            }
          });

          stream.on('error', function(err) {
              console.log(err);
          });
        })
      }
    }

    $(document).ready(function() {
      var phoneNumber = localStorage.getItem("phoneNumber")
      if (!phoneNumber) {
        // $('.phoneNumberSection').show();
      }

      const app = new App();
      $('#listen').click(() => {
        app.startListening();
      });
      $('#callMe').click(() => {
        app.makeCall(localStorage.getItem("phoneNumber"));
      });
    });

    var phoneNumber = ""

    var setNumber = function(){
      phoneNumber = document.getElementById('phone_input').value
      localStorage.setItem("phoneNumber", phoneNumber);
      // $('.phoneNumberSection').hide();
    }
    </script>
    <div class="phoneNumberSection hidden">
      <form>
        <input type="text" id="phone_input" name="phone_number" placeholder="Enter your phone number"><br>
      </form>
      <button onclick="setNumber()">Set the number button</button>
    </div>
    <div>
      <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
      <span class="sr-only">Loading...</span>
    </div>
  </body>
</html>
