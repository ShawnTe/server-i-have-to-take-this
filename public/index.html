<html>
  <head></head>
  <body>
    <div id="output"></div>
    <button id="callMe">Call Me</button>
    <button id="listen">Listen</button>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="watson-speech.js"></script>
    <script>
    class App {
      isTriggerKeyword(data) {
        const parsedData = data.split(" ");
        return parsedData.indexOf('interesting') !== -1;
      }

      startListening() {
        var that = this;
        fetch('http://localhost:3000/watson-token').then(function(response) {
          return response.text();
        }).then((token) => {
          var stream = WatsonSpeech.SpeechToText.recognizeMicrophone({
              token: token,
              keepMic: true
          });

          stream.setEncoding('utf8'); // get text instead of Buffers for on data events

          stream.on('data', function(data) {
            if (that.isTriggerKeyword(data)) {
              stream.stop();
              that.makeCall();
            }
          });

          stream.on('error', function(err) {
              console.log(err);
          });
        })
      }

      makeCall() {
        fetch('http://localhost:3000/call', {
          method: 'POST',
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        });
      }
    }

    $(document).ready(function() {
      const app = new App();
      $('#listen').click(() => {
        app.startListening();
      });
      $('#callMe').click(() => {
        app.makeCall();
      });
    });
    </script>
  </body>
</html>
