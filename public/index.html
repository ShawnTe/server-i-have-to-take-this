<html>
  <head>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/styles.css">
  </head>
  <body>
    <header>
      <p class="phoney-logo"></p>
    </header>
    <div id="main" class="main">
      <div class="homepage">
        <h1>How It Works</h1>
        <ol>
          <li>Trapped!</li>
          <li>Saved by the call</li>
          <li>La Lib√©ration</li>
        </ol>
        <form>
          <div class="form-group">
            <label for="phone_input" class="sr-only">Your phone number</label>
            <input
            type='tel' pattern='\d{10}' title='Phone Number (Format: 4151112222)'
              type="tel"
              id="phone_input"
              class="form-control"
              name="phone_number"
              placeholder="Enter your phone number"
              required
            />
          </div>
          <button type="submit" id="submitPhoneNumber" class="btn btn-default">Save</button>
        </form>
      </div>
      <div class="fake-call-page hidden">
        <button id="callMe">Call Me</button>
        <button id="listen">Listen</button>
        <div>
          <i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i>
          <span class="sr-only">Loading...</span>
        </div>
      </div>
    </div>
    <footer>
      <ul>
        <li>
          <a href="mailto:someone@example.com?Subject=Hello%20again" target="_top">Hire Us!</a>
        </li>
      </ul>
    </footer>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="watson-speech.js"></script>
    <script>
    class App {
      isTriggerKeyword(data) {
        return data.includes('interesting') || data.includes('Interesting');
      }

      makeCall(phoneNumber) {
        console.log('makeCall');
        console.log(phoneNumber)
        fetch('/call', {
          method: 'POST',
          body: JSON.stringify({
            phoneNumber: "+1" + phoneNumber
          }),
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json'
          }
        });
      }

      startListening() {
        var that = this;
        fetch('/watson-token').then(function(response) {
          return response.text();
        }).then((token) => {
          var stream = WatsonSpeech.SpeechToText.recognizeMicrophone({
              token: token,
              keepMic: true
          });

          stream.setEncoding('utf8'); // get text instead of Buffers for on data events

          stream.on('data', function(data) {
            if (that.isTriggerKeyword(data)) {
              console.log('Making a call..');
              stream.stop();
              that.makeCall(localStorage.getItem("phoneNumber"));
            }
          });

          stream.on('error', function(err) {
              console.log(err);
          });
        })
      }
    }

    $(document).ready(function() {
      var phoneNumber = localStorage.getItem("phoneNumber")
      if (!phoneNumber) {
        // $('.phoneNumberSection').show();
      }

      const app = new App();
      $('#submitPhoneNumber').click((event) => {
        // event.preventDefault();
        setNumber();
        // return false;
      });
      $('#listen').click(() => {
        app.startListening();
      });
      $('#callMe').click(() => {
        app.makeCall(localStorage.getItem("phoneNumber"));
      });
    });

    var phoneNumber = "";

    var setNumber = function(event) {
      phoneNumber = document.getElementById('phone_input').value
      localStorage.setItem("phoneNumber", phoneNumber);
      // $('.phoneNumberSection').hide();
    }
    </script>
  </body>
</html>
